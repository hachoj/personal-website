---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import { SOCIALS } from "@/constants";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);

const estimateReadingMinutes = (body: string) => {
  const words = body.trim().split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 220));
};
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="app-layout">
    <section id="hero" class="pt-8 pb-2">
      <h1 class="mb-3 text-[2.45rem] font-semibold tracking-tight">Hello</h1>
      <img
        src="/figures/ink.png"
        alt="Misty Ink Mountain Forest"
        class="h-auto w-full rounded-md border border-border object-contain"
        loading="eager"
      />
      <p class="mt-2 text-[1rem] leading-8 text-foreground/75">
        Welcome to my research blog. I'm interested in basic questions about neural network training.
      </p>
      {
        // only display if at least one social link is enabled
        SOCIALS.length > 0 && (
          <div class="mt-2 flex items-center">
            <Socials />
          </div>
        )
      }
    </section>

    <section id="recent-posts" class="pt-8 pb-8">
      <ul>
        {sortedPosts.map(data => (
          <Card variant="h3" readingTime={estimateReadingMinutes(data.body)} {...data} />
        ))}
      </ul>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
