---
const { entries = [], title = 'Timeline' } = Astro.props;

function extractStartYear(periodShort, period) {
  const source = periodShort || period || '';
  const match = source.match(/(\d{4})/);
  return match ? Number.parseInt(match[1], 10) : 0;
}

function getLogoFallback(organizationKey) {
  if (organizationKey === 'uf_health') return 'UH';
  if (organizationKey === 'uf') return 'UF';
  return 'NA';
}

const sortedEntries = [...entries]
  .map((entry, index) => ({
    ...entry,
    sortYear: extractStartYear(entry.periodShort, entry.period),
    sortIndex: index
  }))
  .sort((a, b) => {
    if (b.sortYear !== a.sortYear) return b.sortYear - a.sortYear;
    return a.sortIndex - b.sortIndex;
  });
---

<section class="section-band section-dense rule-bottom">
  <div class="container">
    <h2 class="section-title">{title}</h2>
    <div id="history" class="timeline-module">
      {sortedEntries.map((entry) => (
        <article class="timeline-row">
          <div class="timespan">
            <span class="timeline-date-text">{entry.periodShort || entry.period}</span>
          </div>
          <div class="timeline-axis" aria-hidden="true">
            <span class="timeline-dot"></span>
          </div>
          <div class="timeline-logo-lane">
            {entry.logo ? (
              <img class="timeline-org-logo" src={entry.logo} alt={`${entry.role} logo`} loading="lazy" />
            ) : (
              <span class="timeline-org-logo-fallback">{getLogoFallback(entry.organizationKey)}</span>
            )}
          </div>
          <div class="timeline-desc">
            <h3 class="timeline-role">{entry.role}</h3>
            <div class="meta-row">
              <span class="meta-item">{entry.period}</span>
              {entry.location && <span class="meta-item">{entry.location}</span>}
              {entry.gpa && <span class="meta-item">GPA {entry.gpa}</span>}
            </div>
            {entry.details && (
              <p class="timeline-paragraph">{entry.details.join(' ')}</p>
            )}
            {entry.relevantCoursework && (
              <>
                <p class="kicker">Relevant Coursework</p>
                <p class="timeline-paragraph">{entry.relevantCoursework.join(', ')}.</p>
              </>
            )}
          </div>
        </article>
      ))}
    </div>
  </div>
</section>
